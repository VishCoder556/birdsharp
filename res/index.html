<!DOCTYPE html>
<html>
<head>
    <title>BirdSharp Wasm Runner</title>
    <style>
        body { font-family: sans-serif; background: #1a1a1a; color: #eee; padding: 20px; }
        #output { background: #000; padding: 15px; border-radius: 5px; font-family: monospace; white-space: pre-wrap; border: 1px solid #444; }
        .reg { color: #00ff00; }
    </style>
</head>
<body>
    <h1>Wasm Register State</h1>
    <div id="output"></div>

    <script>
        async function runWasm() {
            const outElement = document.getElementById('output');
            
            try {
                const response = await fetch('main.wasm');
                if (!response.ok) throw new Error("Could not find main.wasm");
                const bytes = await response.arrayBuffer();

                // Define this outside so js_write can see it
                let wasmInstance;

                const importObject = {
                    env: {
                        js_write: function(fd, ptr, len) {
                            // Pull the buffer from the instance
                            const mem = wasmInstance.exports.memory.buffer;
                            const view = new Uint8Array(mem, ptr, len);
                            const text = new TextDecoder().decode(view);
                            
                            console.log("Wasm Write:", text);
                            outElement.innerText += text;
                        }
                    }
                };

                const { instance } = await WebAssembly.instantiate(bytes, importObject);
                wasmInstance = instance; // Set the reference for the syscall

                // Execute
                if (instance.exports._start) {
                    instance.exports._start();
                }

                // Show Registers
                const v0 = instance.exports.v0 ? instance.exports.v0.value : "N/A";
                const a0 = instance.exports.a0 ? instance.exports.a0.value : "N/A";

                outElement.innerHTML += `\n\n<hr>\n<span class="reg">v0: ${v0}</span>\n<span class="reg">a0: ${a0}</span>\n\n<em>Execution Complete.</em>`;

            } catch (err) {
                outElement.innerHTML = `<span style="color:red">Error: ${err.message}</span><br><small>Check Console (F12) for details.</small>`;
                console.error(err);
            }
        }

        runWasm();
    </script>
</body>
</html>
